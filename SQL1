SELECT 
	sab.id AS account_base_id, 
	CONCAT('(',CONCAT_WS('.', sab.label),') ', sab.remark) AS account_base_label,
	sag.id AS account_group_id, 
	CONCAT('(',CONCAT_WS('.', sab.label, sag.label),') ', sag.remark) AS account_group_label,
	sat.id AS account_type_id, 
	CONCAT('(',CONCAT_WS('.', sab.label, sag.label, sat.label),') ', sat.remark) AS account_type_label,
	sao.id AS account_object_id, 
	CONCAT('(',CONCAT_WS('.', sab.label, sag.label, sat.label, sao.label),') ', sao.remark) AS account_object_label,
	saod.id AS account_object_detail_id, 
	CONCAT('(',CONCAT_WS('.', sab.label, sag.label, sat.label, sao.label, saod.label),') ', saod.remark) AS account_object_detail_label,
	saods.id AS account_object_detail_sub_id, 
	CONCAT('(',CONCAT_WS('.', sab.label, sag.label, sat.label, sao.label, saod.label, saods.label),') ', saods.remark) AS account_object_detail_sub_label,
	COALESCE(b.amount, 0) AS plan_amount,
	COALESCE((SELECT MAX(r.amount)), 0) AS real_amount,
	COALESCE((SELECT MAX(r.date)), b.date) AS trans_date,
	c.id AS city_id,
	c.label AS city_label,
	c.logo AS city_logo
FROM budget b
JOIN account_object_detail_sub saods ON saods.id=b.account_object_detail_sub_id 
	AND saods.active
JOIN account_object_detail saod ON saod.id=saods.account_object_detail_id 
	AND saod.active
JOIN account_object sao ON sao.id=saod.account_object_id
	AND sao.active
JOIN account_type sat ON sat.id=sao.account_type_id
	AND sat.active
JOIN account_group sag ON sag.id=sat.account_group_id
	AND sag.active
JOIN account_base sab ON sab.id=sag.account_base_id
	AND sab.active
	AND (
		LOWER(sab.remark) IN(LOWER('PENDAPATAN DAERAH'), LOWER('BELANJA DAERAH'), LOWER('PEMBIAYAAN DAERAH')) 
		OR
		sab.id IN(4, 5, 6) 
	)  
JOIN city c ON c.id=b.city_id 
	AND c.active
LEFT JOIN realization r ON r.account_object_detail_sub_id=b.account_object_detail_sub_id
	AND r.city_id=b.city_id
	AND YEAR(r.date)=YEAR(b.date)
	AND r.date >= '2024-01-31'
	AND r.date <= '2024-12-31'
WHERE 
	-- YEAR(b.date)=(SELECT u.which_year FROM user u WHERE u.username='adminbatam')
	YEAR(b.date)=2024
	GROUP BY b.account_object_detail_sub_id, b.city_id